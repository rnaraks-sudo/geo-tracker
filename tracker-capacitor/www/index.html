<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="manifest" href="manifest.json" />
  <title>Local Tracker + CO‚ÇÇ (App)</title>
  <style>
    :root { --bg:#0b0f14; --card:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#22d3ee; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b; --border:#1f2937; }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width:960px; margin:0 auto; padding:16px; display:grid; gap:16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1 { font-size:1.25rem; margin:0; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:0 10px 24px rgba(0,0,0,.25); }
    .row { display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .col-6 { grid-column: span 6; } @media (max-width:800px){ .col-6{ grid-column: span 12; } }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    button, select, input[type='number'], input[type='file'] { background:#0f172a; color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-weight:600; letter-spacing:.2px; }
    button { cursor:pointer; }
    button.primary { background:linear-gradient(135deg,#0891b2,#22d3ee); color:#001018; border:none; }
    button.danger { background:#2a0f13; border-color:#7f1d1d; color:#fecaca; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:.9rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New'; }
    .kpi { display:grid; grid-template-columns: repeat(2,1fr); gap:8px; }
    .kpi div { background:#0b1220; border:1px dashed var(--border); border-radius:12px; padding:10px; }
    .kpi .label { color:var(--muted); font-size:.75rem; text-transform:uppercase; letter-spacing:.08em; }
    .kpi .value { font-size:1.1rem; font-weight:700; }
    canvas { width:100%; height:240px; background:#0a0f1a; border:1px solid var(--border); border-radius:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid var(--border); padding:8px; text-align:left; }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    .pill { border:1px solid var(--border); padding:6px 10px; border-radius:999px; display:inline-flex; gap:8px; align-items:center; }
    .pill .dot { width:8px; height:8px; border-radius:50%; background:var(--accent); }
    .tag { font-size:.75rem; opacity:.8; }
    .install { position: fixed; right: 12px; bottom: 12px; background: #0f172a; border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; box-shadow: 0 10px 24px rgba(0,0,0,.25); display:none; }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üìç Local Tracker + CO‚ÇÇ</h1>
      <div class="pill"><span class="dot" id="statusDot"></span><span id="statusText">idle</span></div>
    </header>

    <section class="card">
      <div class="controls">
        <button id="startBtn" class="primary">Start Tracking</button>
        <button id="stopBtn">Pause</button>
        <button id="resetBtn" class="danger">Reset</button>
        <div class="controls">
          <label class="muted">Mode</label>
          <select id="mode">
            <option value="walking">Walking</option>
            <option value="cycling">Cycling</option>
            <option value="motorcycle">Motorcycle</option>
            <option value="car" selected>Car</option>
            <option value="bus">Bus</option>
            <option value="train">Train</option>
            <option value="plane">Plane</option>
            <option value="custom">Custom‚Ä¶</option>
          </select>
          <label class="muted">Factor (kg CO‚ÇÇ / km)</label>
          <input id="factor" type="number" step="0.001" min="0" style="width:110px" />
        </div>
        <div class="controls">
          <button id="exportBtn">Export JSON</button>
          <label class="muted" for="importFile">Import</label>
          <input id="importFile" type="file" accept="application/json" />
        </div>
      </div>
      <p class="muted tag">Install this app for offline use. For always-on background tracking, add a native background-geolocation plugin (see README).</p>
    </section>

    <section class="row">
      <div class="card col-6">
        <h3>Session</h3>
        <div class="kpi">
          <div><div class="label">Started</div><div class="value" id="startedAt">‚Äî</div></div>
          <div><div class="label">Elapsed</div><div class="value" id="elapsed">00:00:00</div></div>
          <div><div class="label">Initial Fix</div><div class="value mono" id="firstLoc">‚Äî</div></div>
          <div><div class="label">Current</div><div class="value mono" id="currLoc">‚Äî</div></div>
          <div><div class="label">Accuracy</div><div class="value" id="accuracy">‚Äî</div></div>
          <div><div class="label">Total Distance</div><div class="value" id="total">0.000 km</div></div>
        </div>
      </div>
      <div class="card col-6">
        <h3>Impact</h3>
        <div class="kpi">
          <div><div class="label">Mode</div><div class="value" id="modeLabel">Car</div></div>
          <div><div class="label">Factor</div><div class="value" id="factorLabel">0.171 kg/km</div></div>
          <div><div class="label">CO‚ÇÇ This Session</div><div class="value" id="co2Session">0.000 kg</div></div>
          <div><div class="label">CO‚ÇÇ Lifetime</div><div class="value" id="co2Lifetime">0.000 kg</div></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Path</h3>
      <canvas id="pathCanvas" width="1000" height="480" aria-label="Path rendering"></canvas>
      <p class="muted tag">Simple path sketch (not a real map). Scale auto-adjusts to your points.</p>
    </section>

    <section class="card">
      <h3>Location History</h3>
      <div style="max-height: 320px; overflow:auto">
        <table>
          <thead>
            <tr><th>#</th><th>Time</th><th>Latitude</th><th>Longitude</th><th>Œî from Prev (m)</th><th>Speed (m/s)</th></tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <details>
        <summary>Advanced options</summary>
        <label class="muted"><input type="checkbox" id="filterAccuracy" checked /> Ignore fixes with accuracy worse than 50 m</label>
        <label class="muted"><input type="checkbox" id="requireMove" /> Only record if moved &gt; 5 m</label>
      </details>
    </section>
    <p class="muted tag">Note: Keep the app on-screen for continuous logging unless you add a background geolocation plugin.</p>
  </div>

  <button class="install" id="installBtn">‚ûï Install</button>

  <script src="./native-bridge.js"></script>
  <script>
    // PWA install prompt
    let deferredPrompt = null;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'block'; });
    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.style.display = 'none';
    });
  </script>

  <script>
    // ----- App logic (same as earlier) -----
    const DEFAULT_FACTORS = { walking:0, cycling:0, motorcycle:0.103, car:0.171, bus:0.105, train:0.041, plane:0.255, custom:0.171 };
    const $ = (id) => document.getElementById(id);
    const fmt = (n, d=3) => Number(n).toFixed(d);
    const km = (m) => m / 1000;
    const toISO = (t) => new Date(t).toLocaleString();
    function haversine(lat1, lon1, lat2, lon2){ const R=6371e3, rad=x=>x*Math.PI/180; const dœÜ=rad(lat2-lat1), dŒª=rad(lon2-lon1); const a=Math.sin(dœÜ/2)**2+Math.cos(rad(lat1))*Math.cos(rad(lat2))*Math.sin(dŒª/2)**2; return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }

    const STORE = { SESSION:'tracker_session_points_v1', META:'tracker_meta_v1', LIFETIME:'tracker_lifetime_v1' };
    const loadJSON=(k,f)=>{ try{const v=localStorage.getItem(k); return v?JSON.parse(v):f;}catch{return f;} };
    const saveJSON=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

    let watchId = null, startedAt = null;
    let points = loadJSON(STORE.SESSION, []);
    let lifetime = loadJSON(STORE.LIFETIME, { distance:0, co2kg:0 });

    const startBtn=$('startBtn'), stopBtn=$('stopBtn'), resetBtn=$('resetBtn'), exportBtn=$('exportBtn'), importFile=$('importFile');
    const statusDot=$('statusDot'), statusText=$('statusText'), startedAtEl=$('startedAt'), elapsedEl=$('elapsed'), firstLocEl=$('firstLoc'), currLocEl=$('currLoc'), accuracyEl=$('accuracy'), totalEl=$('total'), co2SessionEl=$('co2Session'), co2LifetimeEl=$('co2Lifetime');
    const historyBody=$('historyBody'), pathCanvas=$('pathCanvas'), ctx=pathCanvas.getContext('2d'), modeSel=$('mode'), factorInput=$('factor'), modeLabel=$('modeLabel'), factorLabel=$('factorLabel'), filterAccuracy=$('filterAccuracy'), requireMove=$('requireMove');

    modeSel.addEventListener('change', ()=>{ const f=DEFAULT_FACTORS[modeSel.value]??0.171; factorInput.value=f; modeLabel.textContent=modeSel.value[0].toUpperCase()+modeSel.value.slice(1); factorLabel.textContent=`${fmt(f,3)} kg/km`; updateStats(); });
    factorInput.addEventListener('input', ()=>{ const f=Number(factorInput.value||0); factorLabel.textContent=`${fmt(f,3)} kg/km`; updateStats(); });
    (function init(){ modeSel.value='car'; factorInput.value=DEFAULT_FACTORS['car']; modeLabel.textContent='Car'; factorLabel.textContent=`${fmt(DEFAULT_FACTORS['car'],3)} kg/km`; })();

    function setStatus(active){ statusDot.style.background=active?'var(--ok)':'var(--accent)'; statusText.textContent=active?'tracking':'idle'; startBtn.disabled=active; stopBtn.disabled=!active; }
    function startTracking(){
      if (!('geolocation' in navigator)) { alert('Geolocation not supported.'); return; }
      if (watchId !== null) return;
      if (!startedAt) startedAt=Date.now(); setStatus(True);
      try { navigator.wakeLock?.request && navigator.wakeLock.request('screen').catch(()=>{}); } catch(e) {}
      watchId = navigator.geolocation.watchPosition(onPosition, onGeoError, { enableHighAccuracy: true, maximumAge: 1000, timeout: 60000 });
      // Notify native layer if present
      window.dispatchEvent(new CustomEvent('app:start'));
    }
    function stopTracking(){ if (watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; setStatus(false); window.dispatchEvent(new CustomEvent('app:stop')); } }
    function resetAll(){ stopTracking(); points=[]; startedAt=null; saveJSON(STORE.SESSION, points); saveJSON(STORE.META, {startedAt}); redraw(); updateStats(); renderHistory(); }

    function onGeoError(err){ const codes={1:'Permission denied',2:'Position unavailable',3:'Timeout'}; alert('Geolocation error: '+(codes[err.code]||err.message)); setStatus(false); }
    function onPosition(pos){
      const { latitude:lat, longitude:lon, accuracy:acc, speed } = pos.coords;
      const t = pos.timestamp || Date.now();
      if (filterAccuracy.checked && (acc||9999) > 50) return;
      if (points.length){ const prev=points[points.length-1]; const d=haversine(prev.lat,prev.lon,lat,lon); if (requireMove.checked && d<5) return; }
      points.push({ t, lat, lon, acc:acc??null, spd:speed??null });
      saveJSON(STORE.SESSION, points); if (startedAt) saveJSON(STORE.META, { startedAt });
      redraw(); updateStats(); renderHistory();
    }

    function redraw(){
      ctx.clearRect(0,0,pathCanvas.width,pathCanvas.height);
      if (points.length < 2) { drawPoints(); return; }
      const lats=points.map(p=>p.lat), lons=points.map(p=>p.lon);
      const minLat=Math.min(...lats), maxLat=Math.max(...lats), minLon=Math.min(...lons), maxLon=Math.max(...lons);
      const pad=30, w=pathCanvas.width-pad*2, h=pathCanvas.height-pad*2;
      const latSpan=maxLat-minLat||0.0001, lonSpan=maxLon-minLon||0.0001;
      const toXY=(lat,lon)=>[ pad+((lon-minLon)/lonSpan)*w, pad+(1-((lat-minLat)/latSpan))*h ];
      ctx.beginPath(); points.forEach((p,i)=>{ const [x,y]=toXY(p.lat,p.lon); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.strokeStyle='#22d3ee'; ctx.lineWidth=2; ctx.stroke();
      const [sx,sy]=toXY(points[0].lat,points[0].lon), [ex,ey]=toXY(points.at(-1).lat,points.at(-1).lon); drawMarker(sx,sy,'#10b981'); drawMarker(ex,ey,'#f59e0b'); drawPoints(toXY);
    }
    function drawPoints(toXY){ if (!points.length) return; points.forEach((p,i)=>{ const [x,y]=toXY?toXY(p.lat,p.lon):[pathCanvas.width/2,pathCanvas.height/2]; ctx.beginPath(); ctx.arc(x,y,i===0?4:2,0,Math.PI*2); ctx.fillStyle=i===0?'#10b981':'#94a3b8'; ctx.fill(); }); }
    function drawMarker(x,y,color){ ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fillStyle=color; ctx.fill(); ctx.strokeStyle='#0b0f14'; ctx.lineWidth=2; ctx.stroke(); }

    function updateStats(){
      const totalMeters = points.reduce((acc,p,i,arr)=> i===0?0:acc+haversine(arr[i-1].lat,arr[i-1].lon,p.lat,p.lon), 0);
      const totalKm = totalMeters/1000; totalEl.textContent = `${Number(totalKm).toFixed(3)} km`;
      const factor = Number(factorInput.value||0); const mode=modeSel.value; modeLabel.textContent = mode[0].toUpperCase()+mode.slice(1); factorLabel.textContent=`${Number(factor).toFixed(3)} kg/km`;
      co2SessionEl.textContent = `${Number(totalKm*factor).toFixed(3)} kg`;
      if (points.length){ if (!startedAt) startedAt=points[0].t; startedAtEl.textContent=new Date(startedAt).toLocaleString(); const last=points.at(-1); firstLocEl.textContent=`${Number(points[0].lat).toFixed(6)}, ${Number(points[0].lon).toFixed(6)}`; currLocEl.textContent=`${Number(last.lat).toFixed(6)}, ${Number(last.lon).toFixed(6)}`; accuracyEl.textContent = last.acc?`${Number(last.acc).toFixed(0)} m`:'‚Äî'; }
      if (startedAt){ const secs=Math.max(0, Math.floor(((watchId?Date.now():(points.at(-1)?.t||Date.now()))-startedAt)/1000)); const hh=String(Math.floor(secs/3600)).padStart(2,'0'); const mm=String(Math.floor((secs%3600)/60)).padStart(2,'0'); const ss=String(secs%60).padStart(2,'0'); elapsedEl.textContent=`${hh}:${mm}:${ss}`; }
      const lastDistance = loadJSON('tracker_last_total_m_v1', 0); const currentMeters = Math.round(totalMeters);
      if (currentMeters !== lastDistance){ const deltaKm = (currentMeters-lastDistance)/1000; const co2kg = (loadJSON('tracker_lifetime_v1',{co2kg:0}).co2kg)||0; lifetime.distance = (lifetime.distance||0)+Math.max(0,deltaKm); lifetime.co2kg = (lifetime.co2kg||0)+Math.max(0,deltaKm*factor); saveJSON('tracker_lifetime_v1', lifetime); saveJSON('tracker_last_total_m_v1', currentMeters); }
      co2LifetimeEl.textContent = `${Number(lifetime.co2kg||0).toFixed(3)} kg`;
    }

    function renderHistory(){
      historyBody.innerHTML = '';
      points.forEach((p,i)=>{
        const prev=i?points[i-1]:null; const delta=prev?haversine(prev.lat,prev.lon,p.lat,p.lon):0;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td class="mono">${new Date(p.t).toLocaleString()}</td><td class="mono">${Number(p.lat).toFixed(6)}</td><td class="mono">${Number(p.lon).toFixed(6)}</td><td>${delta.toFixed(1)}</td><td>${p.spd!=null?Number(p.spd).toFixed(2):'‚Äî'}</td>`;
        historyBody.appendChild(tr);
      });
    }

    startBtn.addEventListener('click', startTracking);
    stopBtn.addEventListener('click', stopTracking);
    resetBtn.addEventListener('click', ()=>{ if (confirm('Clear current session data?')) resetAll(); });
    exportBtn.addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify({points,lifetime},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`tracker_${new Date().toISOString().replace(/[:.]/g,'-')}.json`; a.click(); URL.revokeObjectURL(url); });
    importFile.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const text=await f.text(); try{ const data=JSON.parse(text); if(Array.isArray(data.points)){ points=data.points; saveJSON(STORE.SESSION,points); } if(data.lifetime){ lifetime=data.lifetime; saveJSON(STORE.LIFETIME,lifetime); } startedAt=points[0]?.t||null; saveJSON(STORE.META,{startedAt}); saveJSON('tracker_last_total_m_v1',0); redraw(); updateStats(); renderHistory(); alert('Imported.'); } catch(err){ alert('Import failed: '+err.message); } e.target.value=''; });

    window.addEventListener('load', async ()=>{ const meta=loadJSON(STORE.META,{}); startedAt=meta.startedAt||null; setStatus(false); redraw(); updateStats(); renderHistory(); if(navigator.permissions?.query){ try{ const st=await navigator.permissions.query({name:'geolocation'}); statusText.textContent = st.state==='granted'?'ready':st.state; }catch{} } });
    setInterval(()=>{ if (watchId!==null) updateStats(); }, 1000);
    window.addEventListener('beforeunload', ()=>{ saveJSON(STORE.SESSION,points); saveJSON(STORE.META,{startedAt}); saveJSON(STORE.LIFETIME,lifetime); });
  </script>
</body>
</html>
